---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by guoyu.
--- DateTime: 2019/2/28 14:53
local BattleSkillEffectViewBase=require("GameLogic.BattleNew.View.Object.BattleSkillEffectViewBase")

local BattleSkillYJEffectView=BaseClass("BattleSkillYJEffectView",BattleSkillEffectViewBase)

local base=BattleSkillEffectViewBase

local function __init(self)
    base.__init(self)

    --刷新前的layer数
    self.preLayer=0
end


local function CreateChild(self,layer)
    if layer > 0 then
        for i=1,layer,1 do
            GameObjectPool:GetInstance():GetGameObjectAsync(self.path,function(child,totalNum)
                if not IsNull(child) then
                    if self.destroy then
                        GameObjectPool:GetInstance():RecycleGameObject(self.path,child)
                    else
                        table.insert(self.inst_games,child)
                        child.transform:SetParent(self.fxLogic.root)
                        if #self.inst_games == totalNum then
                            self.fxLogic:OnInit()
                            self.fxLogic:OnPlay()
                        end
                    end
                else
                    Logger.LogError("预设加载错误  "..self.bailName)
                end
            end,layer)

        end
    else
        local start_index = #self.inst_games
        local end_index = start_index+layer+1
        for i = start_index, end_index,-1 do
            GameObjectPool:GetInstance():RecycleGameObject(self.path,self.inst_games[i])
            table.remove(self.inst_games,i)
        end
    end

end

local function OnInit(self,Id,config,gameObject,owner,effectId,layer)
    base.OnInit(self,Id,config,gameObject,owner,effectId)
    if self.destroy then
        return
    end
    local guadian=self.owner.fxController:GetAnchorTrans(config.FxPosId)--挂在胸前
    self.followTransform=guadian
    self.transform.position=guadian.position--挂在胸前
    self.fxLogic.radius=self.owner.roleConfig.PrefabRadii

    local layer=layer
    self.preLayer=layer
    self.inst_games = {}
    CreateChild(self,layer)
    --self.fxLogic:OnPlay()
end




local function OnRefresh(self,layer)
    base.OnRefresh(self)
    local layer=layer
    if layer==self.preLayer then
        return
    end
    self.fxLogic:OnEnd()
    local interval = layer - self.preLayer
    CreateChild(self,interval)
    self.preLayer=layer
    if layer > 0 then
        self.fxLogic:OnInit()
        self.fxLogic:OnPlay()
    end
end

local function OnDestroy(self)
    table.removebyvalue(self.owner.effectViews,self)
    if not IsNull(self.gameObject) then
        self.fxLogic:OnEnd()
        GameObjectPool:GetInstance():RecycleGameObject("Art/EffectRes/Common/fx_yingji_parent.prefab",self.gameObject)
        for i = #self.inst_games, 1,-1 do
            GameObjectPool:GetInstance():RecycleGameObject(self.path,self.inst_games[i])
        end
        self.inst_games = nil
    end
    self.destroy = true
end
BattleSkillYJEffectView.__init=__init
BattleSkillYJEffectView.OnInit=OnInit
BattleSkillYJEffectView.OnRefresh=OnRefresh
BattleSkillYJEffectView.OnDestroy=OnDestroy
return BattleSkillYJEffectView