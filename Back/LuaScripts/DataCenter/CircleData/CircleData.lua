---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by aaa.
--- DateTime: 2019/2/22 14:12
---

local CircleData = BaseClass("CircleData", Singleton)
local function __init(self)
    self.circle_learn = {}
    self.circle_lv = {1,1,1}
    self.data_state = 0  -- 0-为请求 1-请求中  2-请求结束
end

local function RequestCircleData(self)
    if self.data_state ~= 0 then
        return
    end
    self.data_state = 1
    local msdId = MsgIDDefine.PBTEAM_BATTLE_ARRAY_INFO_REQUEST
    NetManager:GetInstance():SendMessage(msdId,nil,function(msg_obj)
        if msg_obj.OpCode ~= 0 then
            Logger.Log("OnRecvPveStart出错了~")
            UISpecial:GetInstance():UITipText(msg_obj.Packages.msg)
            self.data_state = 0
            return
        end
        self.data_state = 2
        self.circle_learn = {}
        self.circle_lv = {1,1,1}
        if msg_obj.Packages.learnArray and not msg_obj.Packages.learnArray._is_null then
            for i, v in ipairs(msg_obj.Packages.learnArray) do
                self.circle_learn[v] = true
            end
        end
        if msg_obj.Packages.positionLevel and not msg_obj.Packages.positionLevel._is_null then
            for i, v in ipairs(msg_obj.Packages.positionLevel) do
                self.circle_lv[i] = v
            end
        end
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_CIRCLE_INFO_END)
    end)
end

local function LearnCircleRequest(self,id,cost,func)
    local msdId = MsgIDDefine.PBTEAM_BATTLE_ARRAY_STUDY_REQUEST
    local msdObj = MsgIDMap[msdId]()
    msdObj.arrayId = id
    NetManager:GetInstance():SendMessage(msdId,msdObj,function(msg_obj)
        if msg_obj.OpCode ~= 0 then
            Logger.Log("OnRecvPveStart出错了~")
            UISpecial:GetInstance():UITipText(msg_obj.Packages.msg)
            return
        end
        for i, v in ipairs(cost) do
            BackpackData:GetInstance():UpdateItemData(v.id, -v.num)
        end
        self.circle_learn[id] = true
        if func ~= nil then
            func()
        end
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_CIRCLE_INFO_END)
    end)
end

local function CircleLvUp(self,pos,cost)
    local msdId = MsgIDDefine.PBTEAM_BATTLE_ARRAY_POSITION_REQUEST
    local msdObj = MsgIDMap[msdId]()
    msdObj.position = pos
    NetManager:GetInstance():SendMessage(msdId,msdObj,function(msg_obj)
        if msg_obj.OpCode ~= 0 then
            Logger.Log("OnRecvPveStart出错了~")
            UISpecial:GetInstance():UITipText(msg_obj.Packages.msg)
            return
        end
        for i, v in ipairs(cost) do
            BackpackData:GetInstance():UpdateItemData(v.Id, -v.Val)
        end
        self.circle_lv[pos] =  self.circle_lv[pos]+1
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_CIRCLE_INFO_END)
    end)
end

local function GetCircleById(self,id)
    if self.data_state == 0 then
        RequestCircleData(self)
    end
    return self.circle_learn[id]
end

local function GetCircleLv(self)
    if self.data_state == 0 then
        RequestCircleData(self)
    end
    return self.circle_lv
end
CircleData.CircleLvUp = CircleLvUp
CircleData.LearnCircleRequest = LearnCircleRequest
CircleData.GetCircleLv = GetCircleLv
CircleData.GetCircleById = GetCircleById
CircleData.__init = __init

return CircleData