---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by ljl.
--- DateTime: 2019/2/23 15:56
---

local CacoDemonData = BaseClass("CacoDemonData",Singleton)
local global_data = DataUtil.GetData("global")
local wBoss_local_data = DataUtil.GetData("wBoss")
local item_data = DataUtil.GetData("item")
local function __init(self)
    ---恶灵每日的收益次数
    self.earningsTimes = 0
    ---恶灵的数据
    self.cacodemonList = {}
    self.lable2_UIText = ""
    self.curmaxAwardNum = 0
    self.isActive = false
    self.openLv = 0
end

local function GetCacodemonListRequest(self)
    local msg_id = MsgIDDefine.PBFIGHT_GET_CACODEMON_LIST_REQUEST
    NetManager:GetInstance():SendMessage(msg_id,nil,function (msg_obj)
        if msg_obj.OpCode ~= 0 then
            Logger.Log("ERROR PBFIGHT_GET_CACODEMON_LIST_REQUEST~~")
            UISpecial:GetInstance():UITipText(msg_obj.Packages.msg)
            return
        else
            self:GetCacodemonData(msg_obj.Packages.cacodemonList)
            if self.cacodemonList[1].TeamLimitLv > UserData:GetInstance().pLevel then
                self.isActive = true
                self.openLv = self.cacodemonList[1].TeamLimitLv
                UISpecial:GetInstance():UITipText("玩家等级不足"..self.openLv.."级开启")
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIItemJumpTip,1401014)
                return
            end
            --UIManager:GetInstance():OpenWindow(UIWindowNames.UICacodemon)
        end
    end)
end

---刷新恶灵来袭每日的收益次数
local function UpdateEarningsTimes(self,_times)
    self.earningsTimes = _times
    self.lable2_UIText=string.format("次数%d/%d",self.earningsTimes,self.curmaxAwardNum)
end

---添加收益次数
local function AddEarningsTimes(self,_times)
    if self.earningsTimes + _times <= self.curmaxAwardNum then
        self.earningsTimes = self.earningsTimes + _times
    else
        self.earningsTimes = self.curmaxAwardNum
    end
end

---解析获取所以的恶灵突袭数据
local function GetCacodemonData(self,_dataList)
    if _dataList ~= nil and #_dataList > 0 then
        --初始化数据
        self.curmaxAwardNum = global_data[149].valueN
        self.lable2_UIText=string.format("次数%d/%d",self.earningsTimes,self.curmaxAwardNum)
        self.cacodemonList={}
        for _, v in pairs(wBoss_local_data) do
            local GroupItem = {}
            GroupItem.Id = v.Cha
            GroupItem.Name = v.ChaName
            GroupItem.BossNum = v.BossNum
            for _, n in ipairs(_dataList) do
                if  GroupItem.Id == n.cacodemonGroupId then
                    GroupItem.ResidueTime =n.nextRefreshTime
                    break
                end
            end
            GroupItem.TeamLimitLv = v.LevelLimit
            GroupItem.DropShow={}
            GroupItem.AllCanNum = 0
            GroupItem.CanNum = 0
            GroupItem.BgPic = v.BgPic
            for _, vv in ipairs(v.DropShow) do
                local DropShowItem = {}
                DropShowItem.Id=vv.Id
                if item_data[vv.Id] ~= nil then
                    DropShowItem.Icon = item_data[vv.Id].Icon
                    DropShowItem.Quality = item_data[vv.Id].Quality
                end
                DropShowItem.Desc=vv.Desc
                table.insert(GroupItem.DropShow,DropShowItem)
            end
            GroupItem.Bosses={}
            for _, vv in ipairs(v.Bosses) do
                for _, m in ipairs(_dataList) do
                    if vv.Id ==m.cacodemonId then
                        local GroupItemList = {}
                        GroupItemList.Id = vv.Id
                        GroupItemList.Pic = vv.Pic
                        GroupItemList.Name = vv.Name
                        GroupItemList.Des = vv.Story
                        GroupItemList.SkillId = vv.KeySkill
                        GroupItemList.TeamDes = "队伍达到"..GroupItem.TeamLimitLv.."级"
                        if math.floor(GroupItem.TeamLimitLv) > math.floor(UserData:GetInstance().pLevel) then
                            GroupItemList.Lock = true
                        else
                            GroupItemList.Lock = false
                        end
                        GroupItemList.State = m.cacodemonState --恶灵状态 0：未战斗 1：正在战斗 2：已被击退
                        if  GroupItemList.State ~= 0 then
                            GroupItemList.IconId = m.challengerPortraitId
                            GroupItemList.PlayerName = m.challengerName
                            GroupItemList.head = item_data[m.challengerPortraitId].Icon
                            GroupItemList.frame = SpriteDefine:GetItemQualityFrameByType(item_data[m.challengerPortraitId].Quality)
                        end
                        if GroupItemList.State ~= 2 then
                            GroupItem.AllCanNum = GroupItem.AllCanNum + 1
                        end
                        if GroupItemList.State == 0 then
                            GroupItem.CanNum = GroupItem.CanNum + 1
                        end
                        table.insert(GroupItem.Bosses,GroupItemList)
                    end
                end
                table.sort(GroupItem.Bosses,function (a,b) return a.State < b.State end)
            end
            table.insert(self.cacodemonList,GroupItem)
        end
        table.sort(self.cacodemonList,function (a,b) return a.Id < b.Id end)
    end
end

---刷新数据
local function UpdateSingleData(self, _dataList)
    if _dataList == nil or #_dataList <= 0 then
        return
    end
    for _, v in ipairs(self.cacodemonList) do
        for _, m in ipairs(_dataList) do
            if v.Id == m.cacodemonGroupId then
                v.ResidueTime =m.nextRefreshTime
                v.AllCanNum = 0
                v.CanNum = 0
                for _, n in ipairs(v.Bosses) do
                    if n.Id == m.cacodemonId then
                        n.State = m.cacodemonState
                        if  n.State ~= 0 then
                            n.IconId = m.challengerPortraitId
                            n.PlayerName = m.challengerName
                        end
                    end
                    if n.State ~= 2 then
                        v.AllCanNum = v.AllCanNum + 1
                    end
                    if n.State == 0 then
                        v.CanNum = v.CanNum + 1
                    end
                end
                --table.sort(v.Bosses,function (a,b) return a.State < b.State end)
                break;
            end
        end
    end
    DataManager:GetInstance():Broadcast(DataMessageNames.ON_CACODEMON_DATA_UPDATE)
end

CacoDemonData.UpdateSingleData = UpdateSingleData
CacoDemonData.AddEarningsTimes = AddEarningsTimes
CacoDemonData.GetCacodemonListRequest = GetCacodemonListRequest
CacoDemonData.UpdateEarningsTimes = UpdateEarningsTimes
CacoDemonData.GetCacodemonData = GetCacodemonData
CacoDemonData.__init = __init
return CacoDemonData