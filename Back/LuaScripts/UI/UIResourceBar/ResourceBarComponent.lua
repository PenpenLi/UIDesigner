---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by LJ095.
--- DateTime: 2019/2/23 10:17
---

local ResourceBarComponent=BaseClass("ResourceBarComponent", UIBaseContainer);
local base = UIBaseContainer;

local chat_btn_path="chat";
local bg_img_path="Image";
local grid_path="mGrid/Grid";
local lv_data=DataUtil.GetData("team_level")
local function JumpFunc(self,typeParam)
    if typeParam==1001 then--铜币界面跳转
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIExchangeGoldCoins)
    elseif typeParam==1005 then--插槽技能界面跳转打开获取技能经验界面
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIGetSkillExp)
    end
end
--加号按钮点击
local function OnAddBtnClick(self,index)
    LJAudioManger:GetInstance():PlayVoice("UI_CommonClick")
    if self.resouceBarData==nil then
        return;
    end
    local coinId=self.resouceBarData.ItemShow[index][1]
    local itemXlsx =  DataUtil.GetData("item")
    if itemXlsx[coinId]~=nil then
        local itemData=itemXlsx[coinId];
        if itemData.AddJump~=nil then
            UIJumpManager.JumpByTypeAndParam(itemData.AddJump.id,itemData.AddJump.param);
--[[            if itemData.AddJump.id==1 then--打开对应功能
                JumpFunc(self,itemData.AddJump.param[1]);

            elseif itemData.AddJump.id==2 then--打开对应商品的购买界面
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIShopBuyItem,itemData.AddJump.param[1]);
            elseif itemData.AddJump.id==3 then--打开对应派遣巡逻关卡详情界面
                UISpecial:GetInstance():UITipText(DataUtil.GetClientText(100045))
            end]]
        else
            UISpecial:GetInstance():UITipText(DataUtil.GetClientText(100045))
        end

    end

    --UISpecial:GetInstance():UITipText("功能暂未开启~")
end

local function OnCreate(self,hideHG,_windName)
    base.OnCreate(self);
    self.chatBtn=self:AddComponent(UIButton,chat_btn_path);
    self.bgUIImage=self:AddComponent(UIImage,bg_img_path);

    self.chatBtn:SetOnClick(function()
        LJAudioManger:GetInstance():PlayVoice("UI_CommonClick")
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIChat) end);
    self.gridTrans=self:AddComponent(UIBaseContainer,grid_path);

    if hideHG then
        self.bgUIImage:SetActive(false)
    else
        self.bgUIImage:SetActive(true)
    end
    self.windName = _windName
    local prbCount=self.gridTrans.transform.childCount;
    self.componentList={};
    for i = 0, prbCount-1 do
        local singleComTrans=self.gridTrans:AddComponent(UIBaseContainer,i);
        local itemIcon=singleComTrans:AddComponent(UIImage,"Icon",AtlasConfig.DynamicTex);
        local info_iconPress=singleComTrans:AddComponent(UIEventTrigger,"Icon");
        info_iconPress:SetOnLongPress(function()
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIItemTips,self.resouceBarData.ItemShow[i+1][1])
        end,(function()
            UIManager:GetInstance():CloseWindow(UIWindowNames.UIItemTips)
        end),true)
        local numText=singleComTrans:AddComponent(UIText,"GoNum")
        local addBtn=singleComTrans:AddComponent(UIButton,"Add");
        local redImg=singleComTrans:AddComponent(UIImage,"Red");
        addBtn:SetOnClick(self,OnAddBtnClick,i+1);
        table.insert(self.componentList,{trans=singleComTrans,icon=itemIcon,numText=numText,addBtn=addBtn.gameObject,redImg=redImg.gameObject});
    end
    self.mGridObj = UIUtil.FindTrans(self.transform,"mGrid")
    self.mGridObj.gameObject:SetActive(false)
    self.lvObj = UIUtil.FindTrans(self.transform,"mGrid/playerExpObj")
    self.lvRect = UIUtil.FindComponent(self.transform, typeof(CS.UnityEngine.RectTransform), "mGrid/playerExpObj")
    self.lvText = self:AddComponent(UIText,"mGrid/playerExpObj/lvBg/lvText")
    self.lvPerImg = self:AddComponent(UIImage,"mGrid/playerExpObj/LvInfo/LvPer")
    self.expText = self:AddComponent(UIText,"mGrid/playerExpObj/LvInfo/Exp")
    self.addExpBtn = self:AddComponent(UIButton,"mGrid/playerExpObj/LvInfo/AddBtn")
    self.addExpBtn:SetOnClick(function ()
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIItemJumpTip,1401014,nil,self.windName)
    end)
    self.addExpBtn.gameObject:SetActive(UserData:GetInstance().pLevel ~= 150)
    self.mGridObj.gameObject:SetActive(true)
end

local function UpdatePlayerExp(self)
    local userdata =  UserData:GetInstance()
    self.curLevelExp=userdata.curLevelExp
    self.curLevelLimitTxp=userdata.curLevelLimitTxp
    self.exp_percent = self.curLevelExp/self.curLevelLimitTxp
    self.lvText:SetText(userdata.pLevel)
    if userdata.pLevel>=#lv_data then
        self.lvPerImg:SetFillVal(1)
        self.expText:SetText("等级已满")
    else
        self.lvPerImg:SetFillVal(self.exp_percent)
        self.expText:SetText(string.format("%s/%s",math.floor(self.curLevelExp),math.floor(self.curLevelLimitTxp)))
    end
end

--刷新
local function Refresh(self,resouceBarData)
    self.resouceBarData=resouceBarData;
    --self.chatBtn.gameObject:SetActive(resouceBarData.IsShowChat==1);
    for i, v in ipairs(self.componentList) do
        v.trans.gameObject:SetActive(i<=#resouceBarData.ItemShow);
        if i<=#resouceBarData.ItemShow then
            local itemId=resouceBarData.ItemShow[i][1];
            local isShowAdd=resouceBarData.ItemShow[i][2];
            local itemData=DataUtil.GetDataByIdAndType(itemId,14);
            v.icon:SetSpriteName(itemData.icon);
            v.numText:SetText(DataUtil.GetDataNumDes(BackpackData:GetInstance():GetItemNumById(itemId)));
            v.addBtn:SetActive(isShowAdd==1);
            --只有铜币有红点
            if itemId==1401002 and UserData:GetInstance().buy_coin_times == 0 then
                v.redImg:SetActive(true);
            else
                v.redImg:SetActive(false);
            end
        end
    end
    if resouceBarData.ID == ResourceBarType.PASS or  resouceBarData.ID == ResourceBarType.PATROL or resouceBarData.ID == ResourceBarType.PATROL_UI then
        self.lvRect.anchoredPosition = Vector2.New(180 + (3 - #resouceBarData.ItemShow) * 260, -7.5)
        self.lvObj.gameObject:SetActive(true)
        UpdatePlayerExp(self)
    else
        self.lvObj.gameObject:SetActive(false)
    end
end
ResourceBarComponent.OnCreate=OnCreate;
ResourceBarComponent.Refresh=Refresh;
return ResourceBarComponent;