---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by LJ095.
--- DateTime: 2019/5/22 14:31
---

local UILevelNewDetailCtrl = BaseClass("UILevelNewDetailCtrl", UIBaseCtrl)
local BattleFieldManager=require "GameLogic.BattleNew.Logic.Manager.BattleFieldManager"
local BattleAssistFunction = require "GameLogic.BattleNew.BattleAssistFunction"

local function CloseSelf(self)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UILevelNewDetail)
end

local function CostStamina()
    local leveldata = MapData:GetInstance():GetCurSelectLevelData()
    local costStamina = 0
    if leveldata ~= nil then
        costStamina = leveldata._data.CostStamina
    end
    BackpackData:GetInstance():UpdateItemData(CoinDefine.Stamina,-costStamina)
end
--local function EnterFightResponse(msg_obj)
--    Logger.Log("收到进入战斗回复")
--    --NetManager:GetInstance():RemoveListener(MsgIDDefine.PBFIGHT_PVE_ENTER_FIGHT_RESPONSE,EnterFightResponse)
--    if msg_obj.OpCode==0 then
--        Logger.Log("当前打到的关卡是：",_levelData._id);
--        --消耗体力
--        CostStamina()
--        --关闭自己
--        CloseSelf()
--        --进入场景
--        if msg_obj.Packages.type==7 then
--            BattleFieldManager:GetInstance().battleType=BattleEnum.BattleType.GUIDE
--        end
--        BattleFieldManager:GetInstance().battlePackages=msg_obj.Packages
--        SceneManager:GetInstance():SwitchScene(SceneConfig.BattleScene)
--    elseif msg_obj.OpCode==1 then
--        UISpecial:GetInstance():UITipText(msg_obj.Packages.msg)
--    end
--end


local function SendEnterFightRequest(self,leveldata,_isJumpArray,_isRebindScene)
    --保存当前战斗关卡
    local mapData = MapData:GetInstance():SetCurSelectLevelData(leveldata)
    --发送战斗请求到服务器
    local msd_id = MsgIDDefine.PBFIGHT_PVE_ENTER_FIGHT_REQUEST
    local msg = (MsgIDMap[msd_id])()
    msg.fightId=leveldata._id
    BattleFieldManager:GetInstance().fightId=leveldata._id
    BattleFieldManager:GetInstance().battleType=BattleEnum.BattleType.NORMAL
    BattleFieldManager:GetInstance().sceneConfigId=leveldata._data.MapPosId
    Logger.Log("进入战斗数据")
    NetManager:GetInstance():SendMessage(msd_id, msg,function(msg_obj)
        if msg_obj.OpCode==0 then
            MapData:GetInstance():SetSelectChapter(math.floor((leveldata._id/100)%100));
            MapData:GetInstance():SetSelectType(math.floor(leveldata._id/10000))
            --消耗体力
            CostStamina()
            --关闭自己
            CloseSelf()
            --进入场景
            BattleFieldManager:GetInstance().battlePackages=msg_obj .Packages
            if msg_obj.Packages.type==7 then
                BattleFieldManager:GetInstance().battleType=BattleEnum.BattleType.GUIDE
                BattleAssistFunction.EnterGameJumpEmbattle(self,_isRebindScene)
            elseif _isJumpArray then
                BattleAssistFunction.EnterGameJumpEmbattle(self,_isRebindScene)
            else
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIEmBattle2D,nil,nil,_isRebindScene);
            end
        elseif msg_obj.OpCode==1 then
            UISpecial:GetInstance():UITipText(msg_obj.Packages.msg)
        end
    end)
    --NetManager:GetInstance():AddListener(MsgIDDefine.PBFIGHT_PVE_ENTER_FIGHT_RESPONSE,EnterFightResponse,self)
end

local function SendEnterStoryRequest(self,leveldata,_isRebindScene)
    --保存当前战斗关卡
    CloseSelf(self)
    BattleFieldManager:GetInstance().fightId = leveldata._id
    MapData:GetInstance():SetSelectChapter(math.floor((leveldata._id/100)%100));
    MapData:GetInstance():SetSelectType(math.floor(leveldata._id/10000))
    SceneManager:GetInstance():SwitchScene(SceneConfig.StoryScene,nil,nil,_isRebindScene)
    local mapData = MapData:GetInstance()
    mapData.curSelectLevelDoing = leveldata

end

UILevelNewDetailCtrl.CloseSelf=CloseSelf;
UILevelNewDetailCtrl.CostStamina = CostStamina
--UILevelNewDetailCtrl.EnterFightResponse = EnterFightResponse
UILevelNewDetailCtrl.SendEnterFightRequest = SendEnterFightRequest
UILevelNewDetailCtrl.SendEnterStoryRequest = SendEnterStoryRequest
return UILevelNewDetailCtrl