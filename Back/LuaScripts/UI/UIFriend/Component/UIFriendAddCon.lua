---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by aaa.
--- DateTime: 2019/2/27 17:42
---
local UIFriendAddCon = BaseClass("UIBaseContainer", UIBaseContainer)

local base = UIBaseContainer
local UIAddPlayerWrap = require "UI.UIFriend.Component.UIAddPlayerWrap"


--更新玩家列表
local function UpdatePlayerList(self,type)
    if type == 1 then
        self.player_list = self.view.model.recommend_list

    else
        self.player_list = self.view.model.apply_list
    end
    self.player_wrap_group:SetLength(#self.player_list)
    self.player_wrap_group:ResetToBeginning()
end
--切换页签  添加与申请
local function SwitchPage(self,index,force_voice)
    self.dontHaveTip:SetActive(false)
    if not force_voice then
        LJAudioManger:GetInstance():PlayVoice("UI_CommonClick")
    end
    if self.current_page == index then
        return
    end
    if self.last_img ~= nil then
        --self.last_img.img:SetColor32(12,12,12,255)
        self.last_img.img:SetSpriteName("ui_t_c2_002")
        if self.last_img.game then
            self.last_img.game:SetActive(false)
        end
    end
    --self.group[index].img:SetColor32(168,168,168,255)
    self.group[index].img:SetSpriteName("ui_t_c2_001")
    self.last_img = self.group[index]
    if self.group[index].game then
        self.group[index].game:SetActive(true)
    end
    self.current_page = index
    if index == 1 then
        UpdatePlayerList(self,1)
        --SwitchFriendPage(self)
    elseif index == 2 then
        UpdatePlayerList(self,2)
        --SwitchRecentPage(self)
    end
end

-- 创建
local function OnCreate(self)
    base.OnCreate(self)
    --当前好友不存在的提示界面
    self.dontHaveTip=UIUtil.FindTrans(self.transform,"DontHave_tip").gameObject
    self.dontHaveTip:SetActive(false)

    self.group = {{img = false,game = false},{img = false,game = false},{img = false,game = false}}
    local btn = self:AddComponent(UIButton,"Add")
    btn:SetOnClick(self,SwitchPage,1)
    self.group[1].img = self:AddComponent(UIImage,"Add",AtlasConfig.DynamicTex)
    self.group[1].game = UIUtil.FindTrans(self.transform,"AddCon").gameObject
    self.group[1].game:SetActive(false)

    btn = self:AddComponent(UIButton,"Apply")
    btn:SetOnClick(self,SwitchPage,2)
    self.group[2].img = self:AddComponent(UIImage,"Apply",AtlasConfig.DynamicTex)
    self.group[2].game = UIUtil.FindTrans(self.transform,"ApplyCon").gameObject
    self.group[2].game:SetActive(false)

    self.serch_input = self:AddComponent(UIInput,"AddCon/SerchInput")
    local btn = self:AddComponent(UIButton,"AddCon/SerchBtn")
    self.serch_time = 0
    btn:SetOnClick(function()
        self.dontHaveTip:SetActive(false)
        LJAudioManger:GetInstance():PlayVoice("UI_CommonClick")
        local temp_time = Time.time - self.serch_time
        if temp_time < 10 then
            UISpecial:GetInstance():UITipText("操作频繁，请"..math.ceil(10-temp_time).."秒后重试")
            return
        end
        self.serch_time = Time.time
        local str = self.serch_input:GetText()
        local num = DataUtil.GetStringLength(str)
        if num and num > 0 then
            if num <= 20 then
                --ChatData:GetInstance():AddNewChat(str)
                FriendData:GetInstance():SerchPlayer(str,self.dontHaveTip)
                self.serch_input:SetText("")
            else
                UISpecial:GetInstance():UITipText("最大字数不超过20")
            end
        else
            self.player_wrap_group:SetLength(0)
            --UISpecial:GetInstance():UITipText("聊天内容不能为空")
        end
    end)
    btn = self:AddComponent(UIButton,"ApplyCon/AllConfirm")
    btn:SetOnClick(function()
        self.dontHaveTip:SetActive(false)
        LJAudioManger:GetInstance():PlayVoice("UI_CommonClick")
        FriendData:GetInstance():DealFriend(6,nil)
    end)

    btn = self:AddComponent(UIButton,"ApplyCon/AllCancel")
    btn:SetOnClick(function()
        self.dontHaveTip:SetActive(false)
        LJAudioManger:GetInstance():PlayVoice("UI_CommonClick")
        FriendData:GetInstance():DealFriend(7,nil)
    end)

    btn = self:AddComponent(UIButton,"AddCon/Next")
    btn:SetOnClick(function()
        self.dontHaveTip:SetActive(false)
        LJAudioManger:GetInstance():PlayVoice("UI_CommonClick")
        FriendData:GetInstance():GetRecommendList(true)
    end)

    self.player_wrap_group = self:AddComponent(UIWrapGroup3D,"ItemScroll/ItemContent",UIAddPlayerWrap,self)
    self.player_wrap_group:SetLength(0)

--TODO:红点发生更改
    self.apply_red_game = UIUtil.FindTrans(self.transform,"Apply/redpoint").gameObject
end
local function RefreshRedPoint(self)
    self.apply_red_game:SetActive(RedPointData:GetInstance():GetRedState("friend_add_apply"))
end

local function GetPlayerDataById(self,id)
    return self.view.model.all_player[id]
end

local function OnInit(self)
    self.current_page = -1
    SwitchPage(self,1,true)
    RefreshRedPoint(self)
end

local function UpdateList(self)
    UpdatePlayerList(self,self.current_page)
    RefreshRedPoint(self)
end

local function SerchFriend(self,data)
    if data ~= nil then
        self.dontHaveTip:SetActive(false)
        self.player_list = {data}
        self.player_wrap_group:SetLength(1)
        self.player_wrap_group:ResetToBeginning()
    else
        self.player_wrap_group:SetLength(0)
    end
end

local function DealFriend(self,type,id)
    if type == 1 then
        for i = 1,#self.player_list do
            if self.player_list[i].id == id then
                table.remove(self.player_list,i)
                break
            end
        end
        self.player_wrap_group:SetLength(#self.player_list)
        self.player_wrap_group:ResetToBeginning()
    end
end
UIFriendAddCon.GetPlayerDataById = GetPlayerDataById
UIFriendAddCon.UpdateList = UpdateList
UIFriendAddCon.OnInit = OnInit
UIFriendAddCon.OnCreate = OnCreate
UIFriendAddCon.SerchFriend = SerchFriend
UIFriendAddCon.DealFriend =DealFriend
return UIFriendAddCon