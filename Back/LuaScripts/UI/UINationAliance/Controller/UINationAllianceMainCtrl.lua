---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by LJ095.
--- DateTime: 2019/4/26 11:44
---
local UINationAllianceMainCtrl = BaseClass("UINationAllianceMainCtrl", UIBaseCtrl)
local utf8 = require("Common.Tools.utf8")

local function CloseSelf(self)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UINationAllianceMain)
end

local function tempBtnClick(self, index)
    if index == self.model.MAIN_FUNC_INDEX.MY_UNION_INFO then
        local function callBack(opCode, packages)
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MY_UNION_TABS_RES_SWITCH, index)
        end
        NationNetManager:GetInstance():NationUnionSimpleInfoRequest(self.model.unionId, callBack)
    elseif index == self.model.MAIN_FUNC_INDEX.MEMBER_LIST then
        local function callBack(opCode, packages)
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MY_UNION_TABS_RES_SWITCH, index, packages)
        end
        NationNetManager:GetInstance():SendGetUnionMemberListRequest(callBack)
    elseif index == self.model.MAIN_FUNC_INDEX.MANAGER_TAB then
        -- 管理页签
        self:__DoMannagerMainTabLogic(index)
    elseif index == self.model.MAIN_FUNC_INDEX.CAPTURE_TAB then
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MY_UNION_TABS_RES_SWITCH, index)
    elseif index == self.model.MAIN_FUNC_INDEX.NOTE_LIST then
        local function callBack(self, opCode, packages)
            if opCode ~= 0 then
                return
            end
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MY_UNION_TABS_RES_SWITCH,
                    index, { switchType = self.model.SUB_MANAGER_TAB_SWITCH_TYPE.BY_TAB, data = packages })
        end
        --1-事件，2-战斗
        NationNetManager:GetInstance():SendNetMsgGetAllianceLogData(self.model.EnumLogType.Event, Bind(self, callBack))
    end
end

local function __DoMannagerMainTabLogic(self, index)
    if not self.model.hasManagerBtn then
        UISpecial:GetInstance():UITipText(DataUtil.GetClientText(200240))
        return
    end

    if self.model.hasHandleApply then
        self:__DoMannagerSubTabApplyLogic(index)
        return
    end

    if self.model.hasInviteMember then
        self:__DoMannagerSubTabInviteLogic(index)
        return
    end

    -- 一个权限都没有
    Logger.LogError("数据错误既没有邀请权限也没有申请权限!!!")
end

--增量更新推荐列表
local function OnDragAddUnionInviteRecommendRequest (self, pageIndex)
    local function callBack(self, opCode, pageIndex, packages)
        if opCode ~= 0 then
            return
        end
        --Logger.LogVars("tempBtnClick self ,", self, " opCode ,", opCode, " packages , ", packages, "pageIndex ", pageIndex)
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MY_UNION_TABS_RES_SWITCH,
                self.model.MAIN_FUNC_INDEX.MANAGER_TAB, { switchType = self.model.SUB_MANAGER_TAB_SWITCH_TYPE.BY_DATA, targetSubTabIndex = self.model.SUB_MANAGER_TAB_FUNC_INDEX.INVITE_MANAGE, data = packages, pageIndex = pageIndex })
    end

    NationNetManager:GetInstance():SendAddUnionInviteRecommendRequest(pageIndex, Bind(self, callBack))
end


--按下管理页签按钮
local function OnMannagerTabPressed (self, subTabIndex)
    --Logger.LogVars(" OnMannagerTabPressed  self.model.subFuncIndex ", self.model.subFuncIndex, " subTabIndex : ", subTabIndex)
    if subTabIndex == self.model.subFuncIndex then
        return
    end
    -- changetab
    if subTabIndex == self.model.SUB_MANAGER_TAB_FUNC_INDEX.APPLY_MANAGE then
        self:__DoMannagerSubTabApplyLogic(self.model.tabIndex)
    else
        self:__DoMannagerSubTabInviteLogic(self.model.tabIndex)
    end
end

local function __DoMannagerSubTabApplyLogic (self, tabIndex)
    local function callBack(self, opCode, packages)
        if opCode ~= 0 then
            return
        end
        --Logger.LogVars("tempBtnClick self ,", self, " opCode ,", opCode, " packages , ", packages)
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MY_UNION_TABS_RES_SWITCH,
                tabIndex, { switchType = self.model.SUB_MANAGER_TAB_SWITCH_TYPE.BY_TAB, targetSubTabIndex = self.model.SUB_MANAGER_TAB_FUNC_INDEX.APPLY_MANAGE, data = packages })
    end
    NationNetManager:GetInstance():SendGetUnionApplyListRequest(Bind(self, callBack))
end

local function __DoMannagerSubTabInviteLogic (self, tabIndex)
    local function callBack(self, opCode, pageIndex, packages)
        if opCode ~= 0 then
            return
        end
        --Logger.LogVars("tempBtnClick self ,", self, " opCode ,", opCode, " packages , ", packages, "pageIndex ", pageIndex)
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MY_UNION_TABS_RES_SWITCH,
                tabIndex, { switchType = self.model.SUB_MANAGER_TAB_SWITCH_TYPE.BY_TAB, targetSubTabIndex = self.model.SUB_MANAGER_TAB_FUNC_INDEX.INVITE_MANAGE, data = packages, pageIndex = pageIndex })
    end
    NationNetManager:GetInstance():SendAddUnionInviteRecommendRequest(0, Bind(self, callBack))
end

--修改，联盟公告
local function OnSubmitNoticeContent(self, notice)
    if self.model.myUnionMember.positionData.ChangeNotice == nil then
        -- 没有权限修改
        return
    end

    if not string.isNilOrEmpty(notice) then
        local len = utf8.len(notice)
        if len > self.model.NoticeLimit then
            UISpecial:GetInstance():UITipText(string.format(DataUtil.GetClientText(200241), self.model.NoticeLimit))
            return
        end
    end

    NationNetManager:GetInstance():SendNationUpdateUnionNoticeRequest(notice, Bind(self, self.__SendNationUpdateUnionNoticeCallback))
end

--修改，联盟公告回调
local function __SendNationUpdateUnionNoticeCallback(self, opCode, notice)
    if opCode ~= 0 then
        return
    else
        -- 修改成功
        NationUnionData:GetInstance():UpdateMyNationNotice(notice)
    end
end

--params.unionId,params.memberId, msg_obj.Packages.member
local function __SendGetNationOneMemberCallback(self, opCode, unionId, unionName, member)
    if opCode ~= 0 then
        Logger.LogError("SendGetNationOneMemberRequest ERROR ~~ ")
    else
        UIManager:GetInstance():OpenWindow(UIWindowNames.UINationAliancePlayerDetail, unionId, unionName, member)
    end
end

--点击盟友的一个名字，查看盟友的信息
local function OnMemberNameBtnPressed(self, memberID)
    local unionId = self.model.myNationUnion.id
    local leaderUid = memberID
    local nationName = self.model.myNationUnion.name
    NationNetManager:GetInstance():SendGetNationOneMemberRequest(unionId, leaderUid, nationName, Bind(self, __SendGetNationOneMemberCallback))
end

--点击盟主的名字，查看盟主的信息
local function OnLeaderNameBtnPressed(self)
    local unionId = self.model.myNationUnion.id
    local leaderUid = self.model.myNationUnion.leaderUid
    local nationName = self.model.myNationUnion.name
    NationNetManager:GetInstance():SendGetNationOneMemberRequest(unionId, leaderUid, nationName, Bind(self, __SendGetNationOneMemberCallback))
end

local function MemberSetBtnClick(self, index)
    DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MEMBER_CTRL_SETBTN_CLICK, index)
end

local function posCtrlButtonClick(self)
    DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MEMBER_CTRL_POSITION_CLICK)
end

local function tichuButtonClick(self)
    local function callBack()
        NationNetManager:GetInstance():TiChuUnionRequest(self.model.ctrlMember.uid)
    end
    UIManager:GetInstance():OpenTwoButtonTip(DataUtil.GetClientText(200005), DataUtil.GetClientText(200242), DataUtil.GetClientText(200006), DataUtil.GetClientText(200007), callBack, nil)
end

local function shanRangButton(self)
    local function callBack()
        NationNetManager:GetInstance():GrantUnionRequest(self.model.ctrlMember.uid, self.model.ctrlMember.name)
    end
    UIManager:GetInstance():OpenTwoButtonTip(DataUtil.GetClientText(200005), DataUtil.GetClientText(200243), DataUtil.GetClientText(200006), DataUtil.GetClientText(200007), callBack, nil)
end

local function fangQiButton(self)
    local function callBack()
        NationNetManager:GetInstance():FangQiPositionRequest()
    end
    UIManager:GetInstance():OpenTwoButtonTip(DataUtil.GetClientText(200005), DataUtil.GetClientText(200244), DataUtil.GetClientText(200006), DataUtil.GetClientText(200007), callBack, nil)
end

local function tuiChuButton(self)
    local function callBack()
        local function callBack2(opCode, msg)
            if opCode ~= 0 then
                UISpecial:GetInstance():UITipText(msg_obj.Packages.msg)
                return
            end
            NationUnionData:GetInstance():ExitUnion(false)
            UIManager:GetInstance():CloseWindow(UIWindowNames.UINationAllianceMain)
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_USER_UNION_DATA_FLUSH)
        end
        NationNetManager:GetInstance():ExitUnionRequest(callBack2)
    end
    if self.model.myUnionMember.position == NationDefine.NATION_UNION_POSITION.LEADER then
        --盟主
        if #self.model.members > 1 then
            UISpecial:GetInstance():UITipText(DataUtil.GetClientText(200245))
            return
        end
        UIManager:GetInstance():OpenTwoButtonTip(DataUtil.GetClientText(200005), DataUtil.GetClientText(200246), DataUtil.GetClientText(200006), DataUtil.GetClientText(200007), callBack, nil)
    else
        UIManager:GetInstance():OpenTwoButtonTip(DataUtil.GetClientText(200005), DataUtil.GetClientText(200247), DataUtil.GetClientText(200006), DataUtil.GetClientText(200007), callBack, nil)
    end

end

local function posManagerClick(self, position)
    if self.model.ctrlMember.position == position then
        position = NationDefine.NATION_UNION_POSITION.MEMBER --罢免
        local function Confirm()
            local function callBack(opCode, msg, uid, position)
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MEMBER_CTRL_POSITION_MANAGER_CLICK, opCode, msg, uid, position)
            end
            NationNetManager:GetInstance():SendNationUnionPositionManagerRequest(self.model.ctrlMember.uid, position, callBack)
        end
        UIManager:GetInstance():OpenTwoButtonTip(DataUtil.GetClientText(200005), DataUtil.GetClientText(200248), DataUtil.GetClientText(200006), DataUtil.GetClientText(200007), Confirm, nil)
    else
        local function Confirm()
            local function callBack(opCode, msg, uid, position)
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MEMBER_CTRL_POSITION_MANAGER_CLICK, opCode, msg, uid, position)
            end
            NationNetManager:GetInstance():SendNationUnionPositionManagerRequest(self.model.ctrlMember.uid, position, callBack)
        end
        UIManager:GetInstance():OpenTwoButtonTip(DataUtil.GetClientText(200005), DataUtil.GetClientText(200249), DataUtil.GetClientText(200006), DataUtil.GetClientText(200007), Confirm, nil)
    end
end

local function OnConditionSetBtn_UIButton(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UINationAlianceConditionSet)
end

local function OnManagerSubTabApplyItemDealAgreeBtnPressed(self, memberData, isAgree)
    if memberData == nil then
        return
    end
    local function callBack(self, opCode, uid, agree)
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MANAGER_SUB_AGREE_DEAL, opCode, uid, agree)
    end
    NationNetManager:GetInstance():SendNationDealApplyRequest(memberData.uid, isAgree, Bind(self, callBack))

    --DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MANAGER_SUB_AGREE_DEAL, memberData.uid,isAgree)
end

--点击邀请一个玩家
local function OnMannagerSubTabInviteItemDealBtnPressed(self, memberData)
    local function callBack(self, opCode, uid)
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_MANAGER_SUB_INVITE_DEAL, opCode, uid)
    end
    NationNetManager:GetInstance():SendNationInviteUnionRequest(memberData.uid, Bind(self, callBack))
end

local function ExitNationUnionLogic(self)
    UISpecial:GetInstance():UITipText(DataUtil.GetClientText(200250))
    self:CloseSelf()
end

--点击日志的，事件日志和战斗日志，子页签
local function OnClickAllianceLogSubButton(self, type)
    local function callBack(opCode, packages)
        if opCode ~= 0 then
            return
        end
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_UPDATE_LOG, packages, type)
    end
    --1-事件，2-战斗
    NationNetManager:GetInstance():SendNetMsgGetAllianceLogData(type, callBack)
end

--点击日志超链接，打开排行榜
local function OnClickLinkTextOpenRank(self, timeStamp)
    --DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_LOG_RANK_OPEN)
    local function CallBackFunc(msgObj)
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_NATION_UNION_LOG_RANK_OPEN, msgObj)
    end
    NationNetManager:GetInstance():SendNetMsgGetAllianceAttackCityRankData(timeStamp, CallBackFunc)
end

--发送全体邮件
local function SendMailToAllMember(self, title, content)
    local function callBack()
        UISpecial:GetInstance():UITipText(DataUtil.GetClientText(200251))
    end
    NationNetManager:GetInstance():SendMsgToAllMemberMail(title, content, callBack)
end

UINationAllianceMainCtrl.ExitNationUnionLogic = ExitNationUnionLogic
UINationAllianceMainCtrl.OnConditionSetBtn_UIButton = OnConditionSetBtn_UIButton
UINationAllianceMainCtrl.OnDragAddUnionInviteRecommendRequest = OnDragAddUnionInviteRecommendRequest
UINationAllianceMainCtrl.__DoMannagerSubTabInviteLogic = __DoMannagerSubTabInviteLogic
UINationAllianceMainCtrl.__DoMannagerSubTabApplyLogic = __DoMannagerSubTabApplyLogic
UINationAllianceMainCtrl.__DoMannagerMainTabLogic = __DoMannagerMainTabLogic
UINationAllianceMainCtrl.OnMannagerSubTabApplyItemDealArgreeBtnPressed = OnManagerSubTabApplyItemDealAgreeBtnPressed
UINationAllianceMainCtrl.OnMannagerSubTabInviteItemDealBtnPressed = OnMannagerSubTabInviteItemDealBtnPressed

UINationAllianceMainCtrl.OnMemberNameBtnPressed = OnMemberNameBtnPressed
UINationAllianceMainCtrl.__SendNationUpdateUnionNoticeCallback = __SendNationUpdateUnionNoticeCallback

UINationAllianceMainCtrl.OnMannagerTabPressed = OnMannagerTabPressed

UINationAllianceMainCtrl.OnLeaderNameBtnPressed = OnLeaderNameBtnPressed
UINationAllianceMainCtrl.OnSubmitNoticeContent = OnSubmitNoticeContent
UINationAllianceMainCtrl.CloseSelf = CloseSelf
UINationAllianceMainCtrl.tempBtnClick = tempBtnClick
UINationAllianceMainCtrl.MemberSetBtnClick = MemberSetBtnClick
UINationAllianceMainCtrl.posCtrlButtonClick = posCtrlButtonClick
UINationAllianceMainCtrl.tichuButtonClick = tichuButtonClick
UINationAllianceMainCtrl.shanRangButton = shanRangButton
UINationAllianceMainCtrl.fangQiButton = fangQiButton
UINationAllianceMainCtrl.tuiChuButton = tuiChuButton
UINationAllianceMainCtrl.posManagerClick = posManagerClick
UINationAllianceMainCtrl.OnClickAllianceLogSubButton = OnClickAllianceLogSubButton
UINationAllianceMainCtrl.OnClickLinkTextOpenRank = OnClickLinkTextOpenRank
UINationAllianceMainCtrl.SendMailToAllMember = SendMailToAllMember

return UINationAllianceMainCtrl