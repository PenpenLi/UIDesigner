---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by aaa.
--- DateTime: 2018/12/18 18:36
---
local UIBattleSkillTip = BaseClass("UIBattleSkillTip", UIBaseContainer)
local base = UIBaseContainer
local function OnCreate(self)
    base.OnCreate(self)
    self.cost_text = self:AddComponent(UIText,"SkillTip/Num")
    self.name_text = self:AddComponent(UIText,"SkillTip/Name")
    self.des_text = self:AddComponent(UIText,"SkillTip/Content")
    self.crystal_img = self:AddComponent(UIImage,"SkillTip/CrystalType",AtlasConfig.DynamicTex)
    self.skill_trans = UIUtil.FindTrans(self.transform,"SkillTip")
    self.skill_rect = UIUtil.FindComponent(self.transform, typeof(CS.UnityEngine.RectTransform),"SkillTip")
    self.buff_text = self:AddComponent(UIText,"BuffTip/BuffContent")
    self.buff_trans = UIUtil.FindTrans(self.transform,"BuffTip")
    self.buff_rect = UIUtil.FindComponent(self.transform, typeof(CS.UnityEngine.RectTransform),"BuffTip")
    self.close = self:AddComponent(UIButton,"Mask")
    self.close:SetOnClick(function()
        self:OnShowOrHide(false)
    end)
    self:OnShowOrHide(false)
    local layer =  UIManager:GetInstance():GetLayer(UILayers.NormalLayer.Name)
    self.half_width =  UIUtil.FindComponent(layer.transform,typeof(CS.UnityEngine.RectTransform)).sizeDelta.x * 0.5

end
local function GetCrystalImg(type)
    if type == 1 then
        return "ui_t_Card_028"
    elseif type == 2 then
        return "ui_t_Card_029"
    else
        return "ui_t_Card_027"
    end
end

-- 组件被复用时回调该函数，执行组件的刷新
local function OnRefresh(self,data,relative,type,guardianRole)
    if data==nil then
       Logger.LogError("data_is_nil")
        return
    end
    self:OnShowOrHide(true)
    self.buff_trans.gameObject:SetActive(false)
    self.skill_trans.gameObject:SetActive(true)
    self.cost_text:SetText(math.floor(data.cost))
    self.name_text:SetText(data.name)
    self.des_text:SetText("暂无")
    local str = DataUtil.GetSkillDesByIdAndLevel(data.id,data.level,data.breakLevel,data.effectLevel)
    --local skill_info=skillList[data.id]
    --if skill_info then
    --    if skill_info.ExclusiveWeaponEffect~=nil and  skill_info.ExclusiveWeaponEffect ~=0  then
    --        local weapondata=allSkillDescription[skill_info.ExclusiveWeaponEffect]
    --        if weapondata~=nil then
    --            str = str.."\n"..weapondata.Desc
    --        end
    --    end
    --end
    if str ~= nil then
        self.des_text:SetText(str)
    end

    if data.id == 0 and guardianRole ~= nil then
        self.name_text:SetText(CardData:GetInstance().cards[guardianRole.entityId].name.."出场技")
        local cardData=DataUtil.GetData("card");
        local skilEffect=DataUtil.GetData("skill_effect");
        if cardData[guardianRole.entityId] then
            local enterEffectId=cardData[guardianRole.entityId].EnterEffect;
            if skilEffect[enterEffectId] then
                self.des_text:SetText(DataUtil.ParseEnterSkillDes(enterEffectId,1));
            end
        end
    end

    --self.crystal_img:SetSpriteName(GetCrystalImg(data.costType))
    local textHeight = self.des_text:GetPreferredHeight()
    self.skill_rect.sizeDelta = Vector2.New(750, textHeight + 150)
    if type == 1 then
        self.skill_trans.position = relative + Vector3.New(0, textHeight / 2 + 100,0)
    else
        self.skill_trans.position = relative - Vector3.New(0, 20,0)
    end
    local offset = self.half_width + self.skill_rect.anchoredPosition.x - 375
    if offset < 0 then
        self.skill_rect.anchoredPosition = self.skill_rect.anchoredPosition+Vector3.New(-offset,0,0)
    end

end

local function BuffInfo(self,buffId,relative,type)
    self:OnShowOrHide(true)
    self.buff_trans.gameObject:SetActive(true)
    self.skill_trans.gameObject:SetActive(false)
    local skill_effect_buff = DataUtil.GetData("skill_effect_buff")

    local data = skill_effect_buff[buffId]
    if data ~= nil then
        self.buff_text:SetText(data.Des)
    else
        self.buff_text:SetText("暂无")
    end
    local textHeight = self.buff_text:GetPreferredHeight()
    self.buff_rect.sizeDelta = Vector2.New(750, textHeight + 50)
    if type == 1 then
        self.buff_trans.position = relative - Vector3.New(0,-(textHeight / 2 + 25),0)
    else
        self.buff_trans.position = relative - Vector3.New(0,(textHeight / 2 + 25),0)
    end

    local offset = self.half_width + self.buff_rect.anchoredPosition.x - 375
    if offset < 0 then
        self.buff_rect.anchoredPosition = self.buff_rect.anchoredPosition+Vector3.New(-offset,0,0)
    end
end

local function OnShowOrHide(self,show)
    self.gameObject:SetActive(show)
end
UIBattleSkillTip.BuffInfo = BuffInfo
UIBattleSkillTip.OnRefresh = OnRefresh
UIBattleSkillTip.OnShowOrHide = OnShowOrHide
UIBattleSkillTip.OnCreate = OnCreate
return UIBattleSkillTip