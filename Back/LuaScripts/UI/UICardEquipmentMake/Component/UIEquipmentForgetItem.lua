---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by LJ095.
--- DateTime: 2019/8/10 17:39
---

local UIEquipmentForgetItem = BaseClass("UIEquipmentForgetItem", UIBaseContainer);
local base = UIBaseContainer;

local top_obj_path="Production";
local bottom_obj_path="Equipment";
local forge_bg_img_path="Production/Production_Icon";
local forge_name_text_path="Production/Production_Pos";
local forge_cost_icon_path="Production/Production_Costparent/Production_CostIcon";
local forge_cost_text_path="Production/Production_Costparent/Production_CostNum";
local equip_name_text_path="Equipment/CardEquipment_Name/CardEquipment_Name_UIText";
local equip_frame_path="Equipment/CardEquipment_BG";
local equip_icon_path="Equipment/CardEquipment_BG/CardEquipment_Icon";
local equip_lv_path="Equipment/CardEquipment_Level/Subassembly_Level_UIText";
local suit_obj_path="Equipment/CardEquipment_SuitLabel";
local forge_btn_path="Production/Production_BG";
local item_btn_path="Equipment";


--设置持续打造状态
local function SetContinueForgeState(self,_boo)
    self.isContinueForge=_boo;
    self.canvas:SetOrder(1);
end
--打造
local function RequestForgeEquip(self)
    if BackpackData:GetInstance():GetItemNumById(self.data.itemData.id)>=self.data.val then
        self.holdSelf.ctrl:SendForgeEquipRequest(self.realIndex);
    else
        SetContinueForgeState(self,false);
        self.holdSelf.maskBtn.transform.gameObject:SetActive(false);
        UISpecial:GetInstance():UITipText(self.data.itemData.name.."不足");
    end
end

local function OnCreate(self,_holdSelf)
    base.OnCreate(self);
    self.holdSelf=_holdSelf;
    self.forgeBg=self:AddComponent(UIImage,forge_bg_img_path,AtlasConfig.DynamicTex);
    self.forgeName=self:AddComponent(UIText,forge_name_text_path);
    self.topObj=UIUtil.FindTrans(self.transform,top_obj_path);
    self.bottomObj=UIUtil.FindTrans(self.transform,bottom_obj_path);
    self.forgeCostIcon=self:AddComponent(UIImage,forge_cost_icon_path,AtlasConfig.DynamicTex);
    self.forgeCostText=self:AddComponent(UIText,forge_cost_text_path);
    self.equipName=self:AddComponent(UIText,equip_name_text_path);
    self.equipFrame=self:AddComponent(UIImage,equip_frame_path,AtlasConfig.DynamicTex);
    self.equipIcon=self:AddComponent(UIImage,equip_icon_path,AtlasConfig.DynamicTex);
    self.equipLvText=self:AddComponent(UIText,equip_lv_path);
    self.equipSuitObj=UIUtil.FindTrans(self.transform,suit_obj_path);
    self.forgeBtn=self:AddComponent(UIButton,forge_btn_path);
    self.forgeBtn:SetOnClick(function()
        RequestForgeEquip(self);
    end);
    self.canvas=self:AddComponent(UICanvas,"");
    self.itemBtn=self:AddComponent(UIButton,item_btn_path);
    self.itemBtn:SetOnClick(function()
        EquipData:GetInstance():PutCacheEquipsToBackpack(self.equipData.equipId);
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_EQUIP_DECOMPOSE_REFRESH);
        self.topObj.transform.gameObject:SetActive(true);
    end);
end

--刷新锻造的装备
local function RefreshForgeEquip(self,_data)
    self.isContinueForge=self.holdSelf.isContinueForge;
    self.canvas:SetOrder(1);
    self.equipData=_data;
    self.topObj.transform.gameObject:SetActive(false);
    self.equipName:SetText(string.format(UIUtil.GetEquipNameByQuality(_data.itemData.quality),_data.itemData.name));
    self.equipFrame:SetSpriteName(SpriteDefine:GetCardEquipFrameByType(_data.itemData.quality));
    self.equipIcon:SetSpriteName(_data.itemData.icon);
    self.equipLvText:SetText(math.floor(_data.staticData.ShowLv).."级");
    self.equipSuitObj.gameObject:SetActive(_data.staticData.Suit~=-1);
    if _data.itemData.quality==4 then
        SetContinueForgeState(self,false);
        self.holdSelf.maskBtn.transform.gameObject:SetActive(false);
    end
    if  self.isContinueForge then
        self.canvas:SetOrder(5);
        self.holdSelf.maskBtn.transform.gameObject:SetActive(true);
        EquipData:GetInstance():PutCacheEquipsToBackpack(self.equipData.equipId);
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_EQUIP_DECOMPOSE_REFRESH);
        coroutine.start(function ()
            coroutine.waitforseconds(1);
            self.topObj.transform.gameObject:SetActive(true);
            RequestForgeEquip(self);
            coroutine.yieldbreak()
        end)
    end
end



local function Refresh(self,_realIndex,_data)
    self.canvas:SetOrder(1);
    self.topObj.transform.gameObject:SetActive(true);
    self.data=_data;
    self.realIndex=_realIndex;
    self.forgeBg:SetSpriteName(_data.pic);
    self.forgeName:SetText(_data.name);
    self.forgeCostIcon:SetSpriteName(_data.itemData.icon);
    self.forgeCostText:SetText(_data.val);
end

UIEquipmentForgetItem.SetContinueForgeState=SetContinueForgeState;
UIEquipmentForgetItem.RefreshForgeEquip=RefreshForgeEquip;
UIEquipmentForgetItem.OnCreate=OnCreate;
UIEquipmentForgetItem.Refresh=Refresh;
return UIEquipmentForgetItem;