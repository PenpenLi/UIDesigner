
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/3/18 15:48
---引导管理中心   步骤大致
local GuideManager = BaseClass("GuideManager", Singleton)

-- 构造函数
local function __init(self)
    self.DicGuideData={}
    self.finishGroup = {}
    self.canGuide = true
    self:ParseGuideData()
end

local function ParseGuideData(self)
--等待服务器发下来的时候再解析--  step 表ID
    --table={1={1001,1002,100}}
    local GuideData=DataUtil.GetData("guide")
    for i, v in pairs(GuideData) do
        if self.DicGuideData[GuideData[i].group]~=nil then
            self.DicGuideData[GuideData[i].group][GuideData[i].step]=i
        else
            self.DicGuideData[GuideData[i].group]={}
            self.DicGuideData[GuideData[i].group][GuideData[i].step]=i
        end
    end
end



local function SetGuideData(self,group)
    --目前反响通知UI    之后要检测  服务器解析
    --判断当前剧情可不可以触发
    self.finishGroup = {1}
    if group then
        for i, v in ipairs(group) do
            table.insert(self.finishGroup,v)
        end
        Logger.LogVars("SetGuideData self.finishGroup ，",self.finishGroup)
    end
--[[
    for i = 9, 100 do
        if table.keyof(self.finishGroup,i)==nil then
            table.insert(self.finishGroup,i)
        end
    end
--]]
    --table.removebyvalue(self.finishGroup,8)
   return self:CheckLaunchGuide()
    --self.group ==1    直接 开启新手引导战斗
end


--[[获取所有的已完成新手引导步骤]]
local function GetAllGuideFinishGroup(self)
    return self.finishGroup
end


local function SetGuideRecode(group)
    -- Todo 发给服务器 并本地记录
    --默认表格ID是越来越大
    Logger.Log("发送给服务器"..group)
        --TODO 发送给服务器
    local msdId = MsgIDDefine.PBUSER_NOVICE_GUIDE_REQUEST
    local msdObj = MsgIDMap[msdId]()
    msdObj.guide = group
    NetManager:GetInstance():InsetQueneMessage(msdId,msdObj,function(msg_obj)
        if msg_obj.OpCode ~= 0 then
            Logger.Log("OnRecvPveStart出错了~")
            UISpecial:GetInstance():UITipText(msg_obj.Packages.msg)
            return
        end
    end)
end

local function GuideLogReport(step_type,guide_id,guide_name,type,action_type)
    -- Todo 发给服务器 并本地记录
    --默认表格ID是越来越大
    Logger.Log("保存日志"..tostring(guide_name).."  step_type "..tostring(step_type))
    --TODO 发送给服务器
    local msdId = MsgIDDefine.PBUSER_GUIDE_LOG_REQUEST
    local msdObj = MsgIDMap[msdId]()
    msdObj.guildType = step_type
    msdObj.guildId = guide_id
    msdObj.guildName = guide_name
    msdObj.type = type
    msdObj.actionType = action_type
    NetManager:GetInstance():InsetQueneMessage(msdId,msdObj,function(msg_obj)
        if msg_obj.OpCode ~= 0 then
            Logger.Log("OnRecvPveStart出错了~")
            UISpecial:GetInstance():UITipText(msg_obj.Packages.msg)
            return
        end
    end)
end

local function CheckGuideGroupStreng(self)
    if not GuideGroup:GetInstance().Runing then
        if table.keyof(self.finishGroup,9)==nil then
            --走第一步
            GuideCheckManager:GetInstance():CheckLanch(9)
            return true
        elseif table.keyof(self.finishGroup,10)==nil then
            --走第二步
            GuideCheckManager:GetInstance():CheckLanch(10)
            return true
        end
    end
    return false
end

--检测是否新手
local function CheckLaunchGuide(self)
    --开分支
    --首先判断启动新手  总共8步
    if not self.canGuide then
        return -1
    end
    if table.keyof(self.finishGroup,8) == nil then
        return BootGuideManager:GetInstance():CheckGroupCanLanch(self.finishGroup)
    end
    return -1
    --return GuideCheckManager:GetInstance():CheckGroupCanLanch(self.finishGroup)
end

--检测是否有新手运行
local function CheckRunning(self)
    --首先判断启动新手  总共8步
    if table.keyof(self.finishGroup,8) == nil then
        return BootGuideManager:GetInstance().running
    end
    --判断常规
    return GuideGroup:GetInstance().Runing

end
--获取当前新手步骤
local function GetGuideGroup(self)
    --首先判断启动新手  总共8步
    if table.keyof(self.finishGroup,8) == nil then
        return BootGuideManager:GetInstance().current_group
    end
    return -1
end
--获取当前新手表数据
local function GetGuideData(self)
    --首先判断启动新手  总共8步
    if table.keyof(self.finishGroup,8) == nil then
        return BootGuideManager:GetInstance().guide_data
    end
    return nil
end

local function SetGuideServerStep(self,msg)
    if CheckRunning(self) then
        local group = GetGuideGroup(self)
        Logger.Log("服务储存节点   "..group)
        msg.guide = group
    end
end

local function GuideGroupOver(self,group,check)
    table.insert(self.finishGroup,group)
    if check then
        return CheckLaunchGuide(self)
    end
end
--local function LaunchGuide(self,step)
--    GuideGroup:GetInstance():LaunchGuide(step)
--end
local function LaunchGuideWeak(self,step)
    GuideWeakGroup:GetInstance():LaunchGuide(step)
end

local function __delete(self)
    self.DicGuideData= nil
    self.finishGroup = nil
end

--隐藏对话框
local function HideDialog(self)
    if not IsNull(self.dialog_game) then
        GameObjectPool:GetInstance():RecycleGameObject("UI/Prefabs/View/UIGuideDialog.prefab",self.dialog_game)
        self.dialog_game = nil
    end
    if not IsNull(self.dialog_icon_game) then
        CS.UnityEngine.GameObject.Destroy(self.dialog_icon_game)
        self.dialog_icon_game = nil
    end
    self.desc = nil
end
--显示通用对话框
local function ShowCommonDialog(self,desc,talk_name,icon,x,y,parent,fix)
    self.desc = desc
    GameObjectPool:GetInstance():GetGameObjectAsync("UI/Prefabs/View/UIGuideDialog.prefab",function(go)
        if not IsNull(go) then
            self.dialog_game = go
            if self.desc == nil then
                Logger.LogError("--------->ShowCommonDialog  need hide1")
                HideDialog(self)
                return
            end
            local inst_trans = go.transform
            if parent == nil then
                local layer =  UIManager:GetInstance():GetLayer(UILayers.TipLayer.Name)
                UIUtil.SetUIParent(inst_trans,layer.transform)
            else
                UIUtil.SetUIParent(inst_trans,parent.transform)
            end
            if icon ~= nil then
                local dialog_game = UIUtil.FindTrans(inst_trans,"Two").gameObject
                dialog_game:SetActive(false)
                GameObjectPool:GetInstance():GetGameObjectAsync(icon,function(asset)
                    if not IsNull(asset) then
                        if self.dialog_game ~= nil then
                            self.dialog_icon_game = asset
                            if self.desc == nil then
                                Logger.LogError("--------->ShowCommonDialog  need hide2")
                                HideDialog(self)
                            else
                                dialog_game:SetActive(true)
                                local icon_parent = UIUtil.FindTrans(inst_trans,"Two/Portrait")
                                UIUtil.SetUIParent(asset.transform,icon_parent)
                                CS.CommonUtils.PlayPortraitAnim(asset);
                            end
                        else
                            CS.UnityEngine.GameObject.Destroy(asset)
                        end
                    end
                end)
                UIUtil.FindTrans(inst_trans, "One").gameObject:SetActive(false)
                UIUtil.FindText(inst_trans, "Two/Panel/duihua/StoryText").text = desc
                UIUtil.FindText(inst_trans,"Two/Panel/mingzi/NameText").text = talk_name
            else
                UIUtil.FindTrans(inst_trans,"Two").gameObject:SetActive(false)
                local _rect = UIUtil.FindComponent(inst_trans, typeof(CS.UnityEngine.RectTransform),"One")
                _rect.gameObject:SetActive(true)
                local unity_text = UIUtil.FindText(inst_trans, "One/Content_UIText")
                local width = UIUtil.GetTextWidth(unity_text, desc)
                local talkwidth = 0
                local talkheigth = 0
                talkwidth = 447
                if width + 87 < 447 then
                    talkheigth = 134
                else
                    local height = UIUtil.GetTextHeight(unity_text,desc)
                    if height + 50 > 134 then
                        talkheigth = height + 50
                    else
                        talkheigth = 134
                    end
                end
                unity_text.text = desc
                _rect.sizeDelta=Vector2.New(talkwidth,talkheigth)
                if fix then
                    local talk_x=x
                    local talk_y=y
                    if x+talkwidth/2 +166 >fix.sceen_width/2  then
                        --X方向改
                        talk_x=x-fix.size_x-166
                    else
                        talk_x=x+166
                    end

                    if y+talkheigth+86>fix.sceen_height/2 then
                        talk_y=y-talkheigth-fix.size_y-86
                    else
                        talk_y = y+talkheigth/2+86
                    end
                    _rect.localPosition = Vector3.New(talk_x,talk_y,0)
                else
                    _rect.localPosition = Vector3.New(x,y,0)
                end
            end
        end
    end)

end

GuideManager.__delete = __delete
GuideManager.__init = __init
GuideManager.SetGuideRecode = SetGuideRecode
GuideManager.SetGuideData = SetGuideData
GuideManager.ParseGuideData = ParseGuideData
GuideManager.ShowCommonDialog = ShowCommonDialog
GuideManager.CheckLaunchGuide = CheckLaunchGuide
GuideManager.GuideGroupOver = GuideGroupOver
GuideManager.CheckRunning = CheckRunning
GuideManager.GetGuideGroup = GetGuideGroup
GuideManager.GetGuideData = GetGuideData
--GuideManager.LaunchGuide = LaunchGuide
GuideManager.LaunchGuideWeak = LaunchGuideWeak
GuideManager.HideDialog = HideDialog
GuideManager.SetGuideServerStep = SetGuideServerStep
GuideManager.CheckGuideGroupStreng = CheckGuideGroupStreng
GuideManager.GuideLogReport = GuideLogReport
GuideManager.GetAllGuideFinishGroup = GetAllGuideFinishGroup

return GuideManager