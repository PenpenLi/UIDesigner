---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/3/21 18:2
local GuideWeakGroup = BaseClass("GuideWeakGroup", Singleton)
local GuideWeakData = DataUtil.GetData("guide_weak")
-- 构造函数
local function __init(self)
    self.RuningUIName = nil
    self.RuningSceneName = nil
    self.Runing = false
    self.PointDes="弱引导"

end

local function CheckGuideIsDone(self)
    --todo 判断引导组是否结束
    local index=#GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType]
    if self.CurStep>=index then
        return true
    else
        return false
    end
end
local function GetGuideUpStep(self)
    --获得上一步的数据
    if self.CurStep ==1 then
        return nil
    end
    return  GuideWeakData[GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType][self.CurStep-1]]
end
local function GuideGetNextStep(self)
    --TODO 获得下一步
    self.CurStep= self.CurStep+1
    self.CurGuideID=GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType][self.CurStep]
    self.CurGuideItem=GuideWeakData[self.CurGuideID]
    --UI條件
end
local function NextStep(self)
    --如果上传 那么关闭  如果步上传  检测 是否打开这一步的引导 否则关闭
    if not self:CheckGuideIsDone() then
        --没有完成
        self:GuideGetNextStep()
        self:GuideOpenHande()
    else
        --这组最后一步走完了
        if self.CurGuideItem.Nextgroup then
            --直接下一步
            self.CurType= self.CurType+1
            self:LaunchGuide(GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType][1])
        else
            self:SetGuideOver()
            self.CurStep = nil
            self.CurType = nil
            self.RuningSceneName = nil
            self.RuningUIName = nil
            self.RuningTimer = nil
            self.CurGuideItem = nil
            GuideWeakCheckManager:GetInstance().canWeakGuide=false
        end

    end
end


local function LaunchGuide(self,step)
    Logger.Log("LaunchGuide")
    --TODO 拿到当前的步骤   拿到对应事件 对应打开Guide处理
    if GuideWeakData[step] ~= nil and GuideWeakCheckManager:GetInstance().DicGuideWeakData[GuideWeakData[step].group]~=nil then
        --存在
        self.CurType=GuideWeakData[step].group
        if GuideWeakData[step].HandleType==5 then
            for i = 1, #GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType] do
                if GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType][i]~=nil then
                    if GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType][i]==step then
                        self.CurStep=i
                    end
                else
                    Logger.LogError("Bug 引导组没有这个Index"..i)
                end
            end
        else
            for i = 1, #GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType] do
                if GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType][i]~=nil then
                    if GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType][i]==step then
                        self.CurStep=i
                    end
                else
                    Logger.LogError("Bug 引导组没有这个Index"..i)
                end
            end
        end

        if self.CurStep==nil then
            Logger.LogError("Bug 没有获得步骤"..step)
        end
    else
        Logger.LogError("Bug 没有这个ID Or 没有这个引导组"..step)
    end
    self.openGuide=true
    self:GuideOpenHande()

end

local function GuideOpenHande(self)
    --引导在运行
    self.Runing =true
    UIUtil.SetChatImgStatus(false)
    self.RuningSceneName = nil
    self.RuningUIName = nil
    self.RuningTimer = nil
    self.RuningEventName=nil
    --是否满足场景条件
    self.JudgeUIHandle=true
    --是否满足UI条件
    self.JudgeSceneHandle=true
    --是否满足事件条件
    self.JudgeEventHandle=true
    --是否满足等待时间条件
    self.JudgeTimeHandle=true
    if self.RuningTimer then
        self.RuningTimer:Stop()
        self.RuningTimer=nil
    end
    Logger.Log(self.CurType.."/"..self.CurStep)
    self.CurGuideID=GuideWeakCheckManager:GetInstance().DicGuideWeakData[self.CurType][self.CurStep]
    self.CurGuideItem=GuideWeakData[self.CurGuideID]
    --UI條件
    if self.CurGuideItem.NeedUI then
        self.RuningUIName=self.CurGuideItem.NeedUI
        if UIManager:GetInstance():GetWindow(self.RuningUIName,true,true) ~= nil then
            self.JudgeUIHandle=true
        else
            self.JudgeUIHandle=false
        end
    else
        self.RuningUIName=nil
    end
    --場景條件
    if self.CurGuideItem.NeedScene then
        self.RuningSceneName=self.CurGuideItem.NeedScene
        self.JudgeSceneHandle=false
    end
    if  self.CurGuideItem.NeedEvent then
        self.RuningEventName=self.CurGuideItem.NeedEvent
        self.JudgeEventHandle=false
        if not GuideWeakCheckManager:GetInstance().UIAddEventBool then
            GuideWeakCheckManager:GetInstance():AddEventListener()
        else
            Logger.LogError("已经注册 还没移除"..GuideWeakCheckManager:GetInstance().event_name)
        end

    end
    if self.CurGuideItem.NeedTime then
        self.RuningTimer = TimerManager:GetInstance():GetTimer(self.CurGuideItem.NeedTime, self.TimeHandleFun , self,true)
        self.JudgeTimeHandle = false
        if self.JudgeSceneHandle and self.JudgeUIHandle and self.JudgeEventHandle then
            self.RuningTimer:Start()
        end
    end
    self:OpenGuide()
end

--场景回调
local function EventHandleFun(self)
    self.JudgeEventHandle=true
    if self.JudgeUIHandle and  self.JudgeSceneHandle then
        if self.RuningTimer then
            self.RuningTimer:Start()
        end
        self:OpenGuide()
    end

end

local function SceneHandleFun(self)
    self.JudgeSceneHandle=true
    if self.JudgeUIHandle and  self.JudgeEventHandle then
        if self.RuningTimer then
            self.RuningTimer:Start()
        end
        self:OpenGuide()
    end

end
--UI回调
local function UIHandleFun(self,target)
    if target==self.RuningUIName then
        self.JudgeUIHandle=true
        self.RuningUIName=nil
        if self.JudgeEventHandle and self.JudgeSceneHandle then
            if self.RuningTimer then
                self.RuningTimer:Start()
            end
            self:OpenGuide()
        end
    end
end
--时间回调
local function TimeHandleFun(self)
    self.JudgeTimeHandle=true
    if self.RuningTimer ~= nil then
        self.RuningTimer:Stop()
        self.RuningTimer = nil
    end
    self:OpenGuide()
end


local function OpenGuide(self)
    if self.JudgeUIHandle and self.JudgeSceneHandle and self.JudgeTimeHandle and self.JudgeEventHandle then
        Logger.Log("引导打开")
        --DataReportSdkManager.instance.DataReportSdk:MissionBegin(self.PointDes.."--"..self.CurType.."--"..self.CurStep);
            --判断是不是Scene  然后打开战斗UIGuide
        if SceneManager:GetInstance().current_scene.scene_config.Name == SceneConfig.BattleScene.Name and UIManager:GetInstance():GetWindow(UIWindowNames.UIBattleIn,true,true) ~= nil then
            --战斗场景
            if UIManager:GetInstance():GetWindow(UIWindowNames.UIBattleGuide,true,true) ~= nil then
                --已经打开
                UIManager:GetInstance():Broadcast(UIMessageNames.ON_WEAKGUIDE_FUN)
            else
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIBattleGuide)
            end
        else
            if UIManager:GetInstance():GetWindow(UIWindowNames.UIWeakGuide,true,true) ~= nil then
                --已经打开
                UIManager:GetInstance():Broadcast(UIMessageNames.ON_WEAKGUIDE_FUN)
            else
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIWeakGuide)
            end
        end

    end
end
local function SetGuideOver(self)
    self.Runing =false
    UIUtil.SetChatImgStatus(true)
    if UIManager:GetInstance():GetWindow(UIWindowNames.UIBattleGuide,true,true) ~= nil then
        --已经打开
        UIManager:GetInstance():CloseWindow(UIWindowNames.UIBattleGuide);
    end
    if UIManager:GetInstance():GetWindow(UIWindowNames.UIWeakGuide,true,true) ~= nil then
        --已经打开
        UIManager:GetInstance():CloseWindow(UIWindowNames.UIWeakGuide);
    end
end

GuideWeakGroup.__init = __init
GuideWeakGroup.CheckGuideIsDone = CheckGuideIsDone
GuideWeakGroup.LaunchGuide = LaunchGuide
GuideWeakGroup.GuideOpenHande = GuideOpenHande
GuideWeakGroup.SetGuideOver = SetGuideOver
GuideWeakGroup.NextStep = NextStep
GuideWeakGroup.OpenGuide = OpenGuide
GuideWeakGroup.TimeHandleFun = TimeHandleFun
GuideWeakGroup.UIHandleFun = UIHandleFun
GuideWeakGroup.SceneHandleFun = SceneHandleFun
GuideWeakGroup.EventHandleFun = EventHandleFun
GuideWeakGroup.GuideGetNextStep = GuideGetNextStep
GuideWeakGroup.GetGuideUpStep = GetGuideUpStep
return GuideWeakGroup